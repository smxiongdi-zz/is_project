'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.FormDefaultProps = undefined;

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _utils = require('./utils');

var _utils2 = _interopRequireDefault(_utils);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectWithoutProperties(obj, keys) { var target = {}; for (var i in obj) { if (keys.indexOf(i) >= 0) continue; if (!Object.prototype.hasOwnProperty.call(obj, i)) continue; target[i] = obj[i]; } return target; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

var noop = function noop() {};
var reop = function reop(d) {
  return d;
};

var FormDefaultProps = exports.FormDefaultProps = {
  loadState: noop,
  defaultValues: {},
  preValidate: reop,
  validate: function validate() {
    return null;
  },
  onValidationFail: noop,
  onChange: noop,
  saveState: noop,
  willUnmount: noop,
  preSubmit: reop,
  onSubmit: noop,
  postSubmit: noop,
  component: 'div'
};

var Form = function (_React$Component) {
  _inherits(Form, _React$Component);

  function Form(props) {
    _classCallCheck(this, Form);

    var _this = _possibleConstructorReturn(this, (Form.__proto__ || Object.getPrototypeOf(Form)).call(this, props));

    _this.state = _this.getInitialState();

    _this.setAllValues = _this.setAllValues.bind(_this);
    _this.setValue = _this.setValue.bind(_this);
    _this.getValue = _this.getValue.bind(_this);
    _this.setNestedError = _this.setNestedError.bind(_this);
    _this.getError = _this.getError.bind(_this);
    _this.setTouched = _this.setTouched.bind(_this);
    _this.getTouched = _this.getTouched.bind(_this);
    _this.addValue = _this.addValue.bind(_this);
    _this.removeValue = _this.removeValue.bind(_this);
    _this.swapValues = _this.swapValues.bind(_this);
    _this.setAllTouched = _this.setAllTouched.bind(_this);
    _this.resetForm = _this.resetForm.bind(_this);
    _this.submitForm = _this.submitForm.bind(_this);
    _this.getInitialState = _this.getInitialState.bind(_this);
    return _this;
  }

  _createClass(Form, [{
    key: 'getInitialState',
    value: function getInitialState() {
      var _props = this.props,
          defaultValues = _props.defaultValues,
          values = _props.values,
          loadState = _props.loadState;


      var mergedValues = _extends({}, defaultValues, values);

      return loadState(this.props, this) || {
        values: mergedValues,
        touched: {},
        errors: this.validate(mergedValues),
        nestedErrors: {}
      };
    }
  }, {
    key: 'getChildContext',
    value: function getChildContext() {
      return {
        formAPI: this.getAPI()
      };
    }
  }, {
    key: 'componentWillMount',
    value: function componentWillMount() {
      this.emitChange(this.state, true);
    }
  }, {
    key: 'componentWillReceiveProps',
    value: function componentWillReceiveProps(props) {
      if (props.values === this.props.values) {
        return;
      }

      this.setFormState({
        values: props.values || {}
      }, true);
    }
  }, {
    key: 'componentWillUmount',
    value: function componentWillUmount() {
      this.props.willUnmount(this.state, this.props, this);
    }

    // API

  }, {
    key: 'setAllValues',
    value: function setAllValues(values, noTouch) {
      if (noTouch) {
        return this.setFormState({ values: values });
      }
      this.setFormState({ values: values, touched: {} });
    }
  }, {
    key: 'setValue',
    value: function setValue(field, value, noTouch) {
      var state = this.state;
      var values = _utils2.default.set(state.values, field, value);
      // Also set touched since the value is changing
      if (noTouch) {
        return this.setFormState({ values: values });
      }
      var touched = _utils2.default.set(state.touched, field);
      this.setFormState({ values: values, touched: touched });
    }
  }, {
    key: 'getValue',
    value: function getValue(field, fallback) {
      var state = this.state;
      var val = _utils2.default.get(state.values, field);
      return typeof val !== 'undefined' ? val : fallback;
    }
  }, {
    key: 'setNestedError',
    value: function setNestedError(field) {
      var value = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;

      var nestedErrors = _utils2.default.set(this.state.nestedErrors, field, value);
      this.setFormState({ nestedErrors: nestedErrors });
    }
  }, {
    key: 'getError',
    value: function getError(field) {
      return _utils2.default.get(this.state.errors, field);
    }
  }, {
    key: 'setTouched',
    value: function setTouched(field) {
      var value = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;

      var touched = _utils2.default.set(this.state.touched, field, value);
      this.setFormState({ touched: touched });
    }
  }, {
    key: 'getTouched',
    value: function getTouched(field) {
      var state = this.state;
      if (this.state.dirty === true || this.props.touched === true) {
        return true;
      }
      return _utils2.default.get(state.touched, field);
    }
  }, {
    key: 'addValue',
    value: function addValue(field, value) {
      var state = this.state;
      var values = _utils2.default.set(state.values, field, [].concat(_toConsumableArray(_utils2.default.get(state.values, field, [])), [value]));
      this.setFormState({ values: values });
    }
  }, {
    key: 'removeValue',
    value: function removeValue(field, index) {
      var state = this.state;
      var fieldValue = _utils2.default.get(state.values, field, []);
      var values = _utils2.default.set(state.values, field, [].concat(_toConsumableArray(fieldValue.slice(0, index)), _toConsumableArray(fieldValue.slice(index + 1))));
      this.setFormState({ values: values });
    }
  }, {
    key: 'swapValues',
    value: function swapValues(field, index, destIndex) {
      var state = this.state;

      var min = Math.min(index, destIndex);
      var max = Math.max(index, destIndex);

      var fieldValues = _utils2.default.get(state.values, field, []);
      var values = _utils2.default.set(state.values, field, [].concat(_toConsumableArray(fieldValues.slice(0, min)), [fieldValues[max]], _toConsumableArray(fieldValues.slice(min + 1, max)), [fieldValues[min]], _toConsumableArray(fieldValues.slice(max + 1))));
      this.setFormState({ values: values });
    }
  }, {
    key: 'setAllTouched',
    value: function setAllTouched() {
      var dirty = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;
      var state = arguments[1];

      this.setFormState(_extends({}, state, {
        dirty: !!dirty
      }));
    }
  }, {
    key: 'resetForm',
    value: function resetForm() {
      return this.setFormState(this.getInitialState());
    }
  }, {
    key: 'submitForm',
    value: function submitForm(e) {
      e && e.preventDefault && e.preventDefault(e);
      var state = this.state;
      var errors = this.validate(state.values, state, this.props);
      if (errors) {
        if (!state.dirty) {
          this.setAllTouched(true, { errors: errors });
        }
        return this.props.onValidationFail(state.values, state, this.props, this);
      }
      var preSubmitValues = this.props.preSubmit(state.values, state, this.props, this);
      this.props.onSubmit(preSubmitValues, state, this.props, this);
      this.props.postSubmit(preSubmitValues, state, this.props, this);
    }

    // Utils

  }, {
    key: 'getAPI',
    value: function getAPI() {
      return {
        setAllValues: this.setAllValues,
        setValue: this.setValue,
        getValue: this.getValue,
        setNestedError: this.setNestedError,
        getError: this.getError,
        setTouched: this.setTouched,
        getTouched: this.getTouched,
        addValue: this.addValue,
        removeValue: this.removeValue,
        swapValues: this.swapValues,
        setAllTouched: this.setAllTouched,
        resetForm: this.resetForm,
        submitForm: this.submitForm
      };
    }
  }, {
    key: 'setFormState',
    value: function setFormState(newState, silent) {
      var _this2 = this;

      if (newState && newState.values && !newState.errors) {
        newState.values = this.props.preValidate(newState.values, newState, this.props, this);
        newState.errors = this.validate(newState.values, newState, this.props);
      }
      this.setState(newState, function () {
        _this2.props.saveState(_this2.state, _this2.props, _this2);
        if (!silent) {
          _this2.emitChange(_this2.state, _this2.props);
        }
      });
    }
  }, {
    key: 'emitChange',
    value: function emitChange(state, initial) {
      this.props.onChange(state, this.props, initial, this);
    }
  }, {
    key: 'validate',
    value: function validate(values, state, props) {
      var errors = this.props.validate(removeNestedErrorValues(values, this.state ? this.state.nestedErrors : {}), state, props, this);
      return cleanErrors(errors);
    }
  }, {
    key: 'render',
    value: function render() {
      var props = _extends({}, this.props, this.state, this.getAPI());

      var component = props.component,
          children = props.children,
          rest = _objectWithoutProperties(props, ['component', 'children']);

      var resolvedChild = typeof children === 'function' ? children(rest) : children;
      var RootEl = component;
      if (!RootEl) {
        return resolvedChild;
      }
      return _react2.default.createElement(
        RootEl,
        { className: 'ReactForm' },
        resolvedChild
      );
    }
  }]);

  return Form;
}(_react2.default.Component);

Form.displayName = 'Form';
Form.defaultProps = FormDefaultProps;
Form.childContextTypes = { formAPI: _propTypes2.default.object };

exports.default = Form;

// Utils

function cleanErrors(err) {
  if (_utils2.default.isObject(err)) {
    var resolved = _utils2.default.mapValues(err, cleanErrors);
    var found = _utils2.default.pickBy(resolved, function (d) {
      return d;
    });
    return Object.keys(found).length ? resolved : undefined;
  }
  if (_utils2.default.isArray(err)) {
    var _resolved = err.map(cleanErrors);
    var _found = _resolved.find(function (d) {
      return d;
    });
    return _found ? _resolved : undefined;
  }
  return err;
}

// removeNestedErrorValues recurses the values object and turns any
// field that has a truthy corresponding nested form error field into undefined.
// This allows properly validating a nested form by detecting that undefined value
// in the validation function
function removeNestedErrorValues(values, nestedErrors) {
  var recurse = function recurse(current) {
    var path = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];

    if (_utils2.default.isObject(current)) {
      return _utils2.default.mapValues(current, function (d, i) {
        return recurse(d, [].concat(_toConsumableArray(path), [i]));
      });
    }
    if (_utils2.default.isArray(current)) {
      return current.map(function (d, key) {
        return recurse(d, [].concat(_toConsumableArray(path), [key]));
      });
    }
    if (!_utils2.default.isObject(current) && !_utils2.default.isArray(current) && current) {
      return _utils2.default.set(values, path, undefined);
    }
    return current;
  };
  recurse(nestedErrors);
  return values;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9mb3JtLmpzIl0sIm5hbWVzIjpbIm5vb3AiLCJyZW9wIiwiZCIsIkZvcm1EZWZhdWx0UHJvcHMiLCJsb2FkU3RhdGUiLCJkZWZhdWx0VmFsdWVzIiwicHJlVmFsaWRhdGUiLCJ2YWxpZGF0ZSIsIm9uVmFsaWRhdGlvbkZhaWwiLCJvbkNoYW5nZSIsInNhdmVTdGF0ZSIsIndpbGxVbm1vdW50IiwicHJlU3VibWl0Iiwib25TdWJtaXQiLCJwb3N0U3VibWl0IiwiY29tcG9uZW50IiwiRm9ybSIsInByb3BzIiwic3RhdGUiLCJnZXRJbml0aWFsU3RhdGUiLCJzZXRBbGxWYWx1ZXMiLCJiaW5kIiwic2V0VmFsdWUiLCJnZXRWYWx1ZSIsInNldE5lc3RlZEVycm9yIiwiZ2V0RXJyb3IiLCJzZXRUb3VjaGVkIiwiZ2V0VG91Y2hlZCIsImFkZFZhbHVlIiwicmVtb3ZlVmFsdWUiLCJzd2FwVmFsdWVzIiwic2V0QWxsVG91Y2hlZCIsInJlc2V0Rm9ybSIsInN1Ym1pdEZvcm0iLCJ2YWx1ZXMiLCJtZXJnZWRWYWx1ZXMiLCJ0b3VjaGVkIiwiZXJyb3JzIiwibmVzdGVkRXJyb3JzIiwiZm9ybUFQSSIsImdldEFQSSIsImVtaXRDaGFuZ2UiLCJzZXRGb3JtU3RhdGUiLCJub1RvdWNoIiwiZmllbGQiLCJ2YWx1ZSIsInNldCIsImZhbGxiYWNrIiwidmFsIiwiZ2V0IiwiZGlydHkiLCJpbmRleCIsImZpZWxkVmFsdWUiLCJzbGljZSIsImRlc3RJbmRleCIsIm1pbiIsIk1hdGgiLCJtYXgiLCJmaWVsZFZhbHVlcyIsImUiLCJwcmV2ZW50RGVmYXVsdCIsInByZVN1Ym1pdFZhbHVlcyIsIm5ld1N0YXRlIiwic2lsZW50Iiwic2V0U3RhdGUiLCJpbml0aWFsIiwicmVtb3ZlTmVzdGVkRXJyb3JWYWx1ZXMiLCJjbGVhbkVycm9ycyIsImNoaWxkcmVuIiwicmVzdCIsInJlc29sdmVkQ2hpbGQiLCJSb290RWwiLCJDb21wb25lbnQiLCJkaXNwbGF5TmFtZSIsImRlZmF1bHRQcm9wcyIsImNoaWxkQ29udGV4dFR5cGVzIiwib2JqZWN0IiwiZXJyIiwiaXNPYmplY3QiLCJyZXNvbHZlZCIsIm1hcFZhbHVlcyIsImZvdW5kIiwicGlja0J5IiwiT2JqZWN0Iiwia2V5cyIsImxlbmd0aCIsInVuZGVmaW5lZCIsImlzQXJyYXkiLCJtYXAiLCJmaW5kIiwicmVjdXJzZSIsImN1cnJlbnQiLCJwYXRoIiwiaSIsImtleSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFQSxJQUFNQSxPQUFPLFNBQVBBLElBQU8sR0FBTSxDQUFFLENBQXJCO0FBQ0EsSUFBTUMsT0FBTyxTQUFQQSxJQUFPO0FBQUEsU0FBS0MsQ0FBTDtBQUFBLENBQWI7O0FBRU8sSUFBTUMsOENBQW1CO0FBQzlCQyxhQUFXSixJQURtQjtBQUU5QkssaUJBQWUsRUFGZTtBQUc5QkMsZUFBYUwsSUFIaUI7QUFJOUJNLFlBQVU7QUFBQSxXQUFNLElBQU47QUFBQSxHQUpvQjtBQUs5QkMsb0JBQWtCUixJQUxZO0FBTTlCUyxZQUFVVCxJQU5vQjtBQU85QlUsYUFBV1YsSUFQbUI7QUFROUJXLGVBQWFYLElBUmlCO0FBUzlCWSxhQUFXWCxJQVRtQjtBQVU5QlksWUFBVWIsSUFWb0I7QUFXOUJjLGNBQVlkLElBWGtCO0FBWTlCZSxhQUFXO0FBWm1CLENBQXpCOztJQWVEQyxJOzs7QUFDSixnQkFBYUMsS0FBYixFQUFvQjtBQUFBOztBQUFBLDRHQUNaQSxLQURZOztBQUdsQixVQUFLQyxLQUFMLEdBQWEsTUFBS0MsZUFBTCxFQUFiOztBQUVBLFVBQUtDLFlBQUwsR0FBb0IsTUFBS0EsWUFBTCxDQUFrQkMsSUFBbEIsT0FBcEI7QUFDQSxVQUFLQyxRQUFMLEdBQWdCLE1BQUtBLFFBQUwsQ0FBY0QsSUFBZCxPQUFoQjtBQUNBLFVBQUtFLFFBQUwsR0FBZ0IsTUFBS0EsUUFBTCxDQUFjRixJQUFkLE9BQWhCO0FBQ0EsVUFBS0csY0FBTCxHQUFzQixNQUFLQSxjQUFM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UUFBUXhGLENBQVIsK0JBQWUwRixJQUFmLElBQXFCQyxDQUFyQixHQUFQO0FBQ0QsT0FGTSxDQUFQO0FBR0Q7QUFDRCxRQUFJLGdCQUFFTixPQUFGLENBQVVJLE9BQVYsQ0FBSixFQUF3QjtBQUN0QixhQUFPQSxRQUFRSCxHQUFSLENBQVksVUFBQ3RGLENBQUQsRUFBSTRGLEdBQUosRUFBWTtBQUM3QixlQUFPSixRQUFReEYsQ0FBUiwrQkFBZTBGLElBQWYsSUFBcUJFLEdBQXJCLEdBQVA7QUFDRCxPQUZNLENBQVA7QUFHRDtBQUNELFFBQUksQ0FBQyxnQkFBRWhCLFFBQUYsQ0FBV2EsT0FBWCxDQUFELElBQXdCLENBQUMsZ0JBQUVKLE9BQUYsQ0FBVUksT0FBVixDQUF6QixJQUErQ0EsT0FBbkQsRUFBNEQ7QUFDMUQsYUFBTyxnQkFBRTdDLEdBQUYsQ0FBTVosTUFBTixFQUFjMEQsSUFBZCxFQUFvQk4sU0FBcEIsQ0FBUDtBQUNEO0FBQ0QsV0FBT0ssT0FBUDtBQUNELEdBZkQ7QUFnQkFELFVBQVFwRCxZQUFSO0FBQ0EsU0FBT0osTUFBUDtBQUNEIiwiZmlsZSI6ImZvcm0uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnXG5pbXBvcnQgXyBmcm9tICcuL3V0aWxzJ1xuXG5jb25zdCBub29wID0gKCkgPT4ge31cbmNvbnN0IHJlb3AgPSBkID0+IGRcblxuZXhwb3J0IGNvbnN0IEZvcm1EZWZhdWx0UHJvcHMgPSB7XG4gIGxvYWRTdGF0ZTogbm9vcCxcbiAgZGVmYXVsdFZhbHVlczoge30sXG4gIHByZVZhbGlkYXRlOiByZW9wLFxuICB2YWxpZGF0ZTogKCkgPT4gbnVsbCxcbiAgb25WYWxpZGF0aW9uRmFpbDogbm9vcCxcbiAgb25DaGFuZ2U6IG5vb3AsXG4gIHNhdmVTdGF0ZTogbm9vcCxcbiAgd2lsbFVubW91bnQ6IG5vb3AsXG4gIHByZVN1Ym1pdDogcmVvcCxcbiAgb25TdWJtaXQ6IG5vb3AsXG4gIHBvc3RTdWJtaXQ6IG5vb3AsXG4gIGNvbXBvbmVudDogJ2Rpdidcbn1cblxuY2xhc3MgRm9ybSBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCB7XG4gIGNvbnN0cnVjdG9yIChwcm9wcykge1xuICAgIHN1cGVyKHByb3BzKVxuXG4gICAgdGhpcy5zdGF0ZSA9IHRoaXMuZ2V0SW5pdGlhbFN0YXRlKClcblxuICAgIHRoaXMuc2V0QWxsVmFsdWVzID0gdGhpcy5zZXRBbGxWYWx1ZXMuYmluZCh0aGlzKVxuICAgIHRoaXMuc2V0VmFsdWUgPSB0aGlzLnNldFZhbHVlLmJpbmQodGhpcylcbiAgICB0aGlzLmdldFZhbHVlID0gdGhpcy5nZXRWYWx1ZS5iaW5kKHRoaXMpXG4gICAgdGhpcy5zZXROZXN0ZWRFcnJvciA9IHRoaXMuc2V0TmVzdGVkRXJyb3IuYmluZCh0aGlzKVxuICAgIHRoaXMuZ2V0RXJyb3IgPSB0aGlzLmdldEVycm9yLmJpbmQodGhpcylcbiAgICB0aGlzLnNldFRvdWNoZWQgPSB0aGlzLnNldFRvdWNoZWQuYmluZCh0aGlzKVxuICAgIHRoaXMuZ2V0VG91Y2hlZCA9IHRoaXMuZ2V0VG91Y2hlZC5iaW5kKHRoaXMpXG4gICAgdGhpcy5hZGRWYWx1ZSA9IHRoaXMuYWRkVmFsdWUuYmluZCh0aGlzKVxuICAgIHRoaXMucmVtb3ZlVmFsdWUgPSB0aGlzLnJlbW92ZVZhbHVlLmJpbmQodGhpcylcbiAgICB0aGlzLnN3YXBWYWx1ZXMgPSB0aGlzLnN3YXBWYWx1ZXMuYmluZCh0aGlzKVxuICAgIHRoaXMuc2V0QWxsVG91Y2hlZCA9IHRoaXMuc2V0QWxsVG91Y2hlZC5iaW5kKHRoaXMpXG4gICAgdGhpcy5yZXNldEZvcm0gPSB0aGlzLnJlc2V0Rm9ybS5iaW5kKHRoaXMpXG4gICAgdGhpcy5zdWJtaXRGb3JtID0gdGhpcy5zdWJtaXRGb3JtLmJpbmQodGhpcylcbiAgICB0aGlzLmdldEluaXRpYWxTdGF0ZSA9IHRoaXMuZ2V0SW5pdGlhbFN0YXRlLmJpbmQodGhpcylcbiAgfVxuXG4gIGdldEluaXRpYWxTdGF0ZSAoKSB7XG4gICAgY29uc3Qge1xuICAgICAgZGVmYXVsdFZhbHVlcyxcbiAgICAgIHZhbHVlcyxcbiAgICAgIGxvYWRTdGF0ZVxuICAgIH0gPSB0aGlzLnByb3BzXG5cbiAgICBjb25zdCBtZXJnZWRWYWx1ZXMgPSB7XG4gICAgICAuLi5kZWZhdWx0VmFsdWVzLFxuICAgICAgLi4udmFsdWVzXG4gICAgfVxuXG4gICAgcmV0dXJuIGxvYWRTdGF0ZSh0aGlzLnByb3BzLCB0aGlzKSB8fCB7XG4gICAgICB2YWx1ZXM6IG1lcmdlZFZhbHVlcyxcbiAgICAgIHRvdWNoZWQ6IHt9LFxuICAgICAgZXJyb3JzOiB0aGlzLnZhbGlkYXRlKG1lcmdlZFZhbHVlcyksXG4gICAgICBuZXN0ZWRFcnJvcnM6IHt9XG4gICAgfVxuICB9XG5cbiAgZ2V0Q2hpbGRDb250ZXh0ICgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgZm9ybUFQSTogdGhpcy5nZXRBUEkoKVxuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxNb3VudCAoKSB7XG4gICAgdGhpcy5lbWl0Q2hhbmdlKHRoaXMuc3RhdGUsIHRydWUpXG4gIH1cblxuICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIChwcm9wcykge1xuICAgIGlmIChwcm9wcy52YWx1ZXMgPT09IHRoaXMucHJvcHMudmFsdWVzKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICB0aGlzLnNldEZvcm1TdGF0ZSh7XG4gICAgICB2YWx1ZXM6IHByb3BzLnZhbHVlcyB8fCB7fVxuICAgIH0sIHRydWUpXG4gIH1cblxuICBjb21wb25lbnRXaWxsVW1vdW50ICgpIHtcbiAgICB0aGlzLnByb3BzLndpbGxVbm1vdW50KHRoaXMuc3RhdGUsIHRoaXMucHJvcHMsIHRoaXMpXG4gIH1cblxuICAvLyBBUElcbiAgc2V0QWxsVmFsdWVzICh2YWx1ZXMsIG5vVG91Y2gpIHtcbiAgICBpZiAobm9Ub3VjaCkge1xuICAgICAgcmV0dXJuIHRoaXMuc2V0Rm9ybVN0YXRlKHt2YWx1ZXN9KVxuICAgIH1cbiAgICB0aGlzLnNldEZvcm1TdGF0ZSh7dmFsdWVzLCB0b3VjaGVkOiB7fX0pXG4gIH1cblxuICBzZXRWYWx1ZSAoZmllbGQsIHZhbHVlLCBub1RvdWNoKSB7XG4gICAgY29uc3Qgc3RhdGUgPSB0aGlzLnN0YXRlXG4gICAgY29uc3QgdmFsdWVzID0gXy5zZXQoc3RhdGUudmFsdWVzLCBmaWVsZCwgdmFsdWUpXG4gICAgLy8gQWxzbyBzZXQgdG91Y2hlZCBzaW5jZSB0aGUgdmFsdWUgaXMgY2hhbmdpbmdcbiAgICBpZiAobm9Ub3VjaCkge1xuICAgICAgcmV0dXJuIHRoaXMuc2V0Rm9ybVN0YXRlKHt2YWx1ZXN9KVxuICAgIH1cbiAgICBjb25zdCB0b3VjaGVkID0gXy5zZXQoc3RhdGUudG91Y2hlZCwgZmllbGQpXG4gICAgdGhpcy5zZXRGb3JtU3RhdGUoe3ZhbHVlcywgdG91Y2hlZH0pXG4gIH1cblxuICBnZXRWYWx1ZSAoZmllbGQsIGZhbGxiYWNrKSB7XG4gICAgY29uc3Qgc3RhdGUgPSB0aGlzLnN0YXRlXG4gICAgY29uc3QgdmFsID0gXy5nZXQoc3RhdGUudmFsdWVzLCBmaWVsZClcbiAgICByZXR1cm4gdHlwZW9mIHZhbCAhPT0gJ3VuZGVmaW5lZCcgPyB2YWwgOiBmYWxsYmFja1xuICB9XG5cbiAgc2V0TmVzdGVkRXJyb3IgKGZpZWxkLCB2YWx1ZSA9IHRydWUpIHtcbiAgICBjb25zdCBuZXN0ZWRFcnJvcnMgPSBfLnNldCh0aGlzLnN0YXRlLm5lc3RlZEVycm9ycywgZmllbGQsIHZhbHVlKVxuICAgIHRoaXMuc2V0Rm9ybVN0YXRlKHtuZXN0ZWRFcnJvcnN9KVxuICB9XG5cbiAgZ2V0RXJyb3IgKGZpZWxkKSB7XG4gICAgcmV0dXJuIF8uZ2V0KHRoaXMuc3RhdGUuZXJyb3JzLCBmaWVsZClcbiAgfVxuXG4gIHNldFRvdWNoZWQgKGZpZWxkLCB2YWx1ZSA9IHRydWUpIHtcbiAgICBjb25zdCB0b3VjaGVkID0gXy5zZXQodGhpcy5zdGF0ZS50b3VjaGVkLCBmaWVsZCwgdmFsdWUpXG4gICAgdGhpcy5zZXRGb3JtU3RhdGUoe3RvdWNoZWR9KVxuICB9XG5cbiAgZ2V0VG91Y2hlZCAoZmllbGQpIHtcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuc3RhdGVcbiAgICBpZiAodGhpcy5zdGF0ZS5kaXJ0eSA9PT0gdHJ1ZSB8fCB0aGlzLnByb3BzLnRvdWNoZWQgPT09IHRydWUpIHtcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICAgIHJldHVybiBfLmdldChzdGF0ZS50b3VjaGVkLCBmaWVsZClcbiAgfVxuXG4gIGFkZFZhbHVlIChmaWVsZCwgdmFsdWUpIHtcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuc3RhdGVcbiAgICBjb25zdCB2YWx1ZXMgPSBfLnNldChzdGF0ZS52YWx1ZXMsIGZpZWxkLCBbXG4gICAgICAuLi5fLmdldChzdGF0ZS52YWx1ZXMsIGZpZWxkLCBbXSksXG4gICAgICB2YWx1ZVxuICAgIF0pXG4gICAgdGhpcy5zZXRGb3JtU3RhdGUoe3ZhbHVlc30pXG4gIH1cblxuICByZW1vdmVWYWx1ZSAoZmllbGQsIGluZGV4KSB7XG4gICAgY29uc3Qgc3RhdGUgPSB0aGlzLnN0YXRlXG4gICAgY29uc3QgZmllbGRWYWx1ZSA9IF8uZ2V0KHN0YXRlLnZhbHVlcywgZmllbGQsIFtdKVxuICAgIGNvbnN0IHZhbHVlcyA9IF8uc2V0KHN0YXRlLnZhbHVlcywgZmllbGQsIFtcbiAgICAgIC4uLmZpZWxkVmFsdWUuc2xpY2UoMCwgaW5kZXgpLFxuICAgICAgLi4uZmllbGRWYWx1ZS5zbGljZShpbmRleCArIDEpXG4gICAgXSlcbiAgICB0aGlzLnNldEZvcm1TdGF0ZSh7dmFsdWVzfSlcbiAgfVxuXG4gIHN3YXBWYWx1ZXMgKGZpZWxkLCBpbmRleCwgZGVzdEluZGV4KSB7XG4gICAgY29uc3Qgc3RhdGUgPSB0aGlzLnN0YXRlXG5cbiAgICBjb25zdCBtaW4gPSBNYXRoLm1pbihpbmRleCwgZGVzdEluZGV4KVxuICAgIGNvbnN0IG1heCA9IE1hdGgubWF4KGluZGV4LCBkZXN0SW5kZXgpXG5cbiAgICBjb25zdCBmaWVsZFZhbHVlcyA9IF8uZ2V0KHN0YXRlLnZhbHVlcywgZmllbGQsIFtdKVxuICAgIGNvbnN0IHZhbHVlcyA9IF8uc2V0KHN0YXRlLnZhbHVlcywgZmllbGQsIFtcbiAgICAgIC4uLmZpZWxkVmFsdWVzLnNsaWNlKDAsIG1pbiksXG4gICAgICBmaWVsZFZhbHVlc1ttYXhdLFxuICAgICAgLi4uZmllbGRWYWx1ZXMuc2xpY2UobWluICsgMSwgbWF4KSxcbiAgICAgIGZpZWxkVmFsdWVzW21pbl0sXG4gICAgICAuLi5maWVsZFZhbHVlcy5zbGljZShtYXggKyAxKVxuICAgIF0pXG4gICAgdGhpcy5zZXRGb3JtU3RhdGUoe3ZhbHVlc30pXG4gIH1cblxuICBzZXRBbGxUb3VjaGVkIChkaXJ0eSA9IHRydWUsIHN0YXRlKSB7XG4gICAgdGhpcy5zZXRGb3JtU3RhdGUoe1xuICAgICAgLi4uc3RhdGUsXG4gICAgICBkaXJ0eTogISFkaXJ0eVxuICAgIH0pXG4gIH1cblxuICByZXNldEZvcm0gKCkge1xuICAgIHJldHVybiB0aGlzLnNldEZvcm1TdGF0ZSh0aGlzLmdldEluaXRpYWxTdGF0ZSgpKVxuICB9XG5cbiAgc3VibWl0Rm9ybSAoZSkge1xuICAgIGUgJiYgZS5wcmV2ZW50RGVmYXVsdCAmJiBlLnByZXZlbnREZWZhdWx0KGUpXG4gICAgY29uc3Qgc3RhdGUgPSB0aGlzLnN0YXRlXG4gICAgY29uc3QgZXJyb3JzID0gdGhpcy52YWxpZGF0ZShzdGF0ZS52YWx1ZXMsIHN0YXRlLCB0aGlzLnByb3BzKVxuICAgIGlmIChlcnJvcnMpIHtcbiAgICAgIGlmICghc3RhdGUuZGlydHkpIHtcbiAgICAgICAgdGhpcy5zZXRBbGxUb3VjaGVkKHRydWUsIHtlcnJvcnN9KVxuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXMucHJvcHMub25WYWxpZGF0aW9uRmFpbChzdGF0ZS52YWx1ZXMsIHN0YXRlLCB0aGlzLnByb3BzLCB0aGlzKVxuICAgIH1cbiAgICBjb25zdCBwcmVTdWJtaXRWYWx1ZXMgPSB0aGlzLnByb3BzLnByZVN1Ym1pdChzdGF0ZS52YWx1ZXMsIHN0YXRlLCB0aGlzLnByb3BzLCB0aGlzKVxuICAgIHRoaXMucHJvcHMub25TdWJtaXQocHJlU3VibWl0VmFsdWVzLCBzdGF0ZSwgdGhpcy5wcm9wcywgdGhpcylcbiAgICB0aGlzLnByb3BzLnBvc3RTdWJtaXQocHJlU3VibWl0VmFsdWVzLCBzdGF0ZSwgdGhpcy5wcm9wcywgdGhpcylcbiAgfVxuXG4gIC8vIFV0aWxzXG4gIGdldEFQSSAoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNldEFsbFZhbHVlczogdGhpcy5zZXRBbGxWYWx1ZXMsXG4gICAgICBzZXRWYWx1ZTogdGhpcy5zZXRWYWx1ZSxcbiAgICAgIGdldFZhbHVlOiB0aGlzLmdldFZhbHVlLFxuICAgICAgc2V0TmVzdGVkRXJyb3I6IHRoaXMuc2V0TmVzdGVkRXJyb3IsXG4gICAgICBnZXRFcnJvcjogdGhpcy5nZXRFcnJvcixcbiAgICAgIHNldFRvdWNoZWQ6IHRoaXMuc2V0VG91Y2hlZCxcbiAgICAgIGdldFRvdWNoZWQ6IHRoaXMuZ2V0VG91Y2hlZCxcbiAgICAgIGFkZFZhbHVlOiB0aGlzLmFkZFZhbHVlLFxuICAgICAgcmVtb3ZlVmFsdWU6IHRoaXMucmVtb3ZlVmFsdWUsXG4gICAgICBzd2FwVmFsdWVzOiB0aGlzLnN3YXBWYWx1ZXMsXG4gICAgICBzZXRBbGxUb3VjaGVkOiB0aGlzLnNldEFsbFRvdWNoZWQsXG4gICAgICByZXNldEZvcm06IHRoaXMucmVzZXRGb3JtLFxuICAgICAgc3VibWl0Rm9ybTogdGhpcy5zdWJtaXRGb3JtXG4gICAgfVxuICB9XG5cbiAgc2V0Rm9ybVN0YXRlIChuZXdTdGF0ZSwgc2lsZW50KSB7XG4gICAgaWYgKG5ld1N0YXRlICYmIG5ld1N0YXRlLnZhbHVlcyAmJiAhbmV3U3RhdGUuZXJyb3JzKSB7XG4gICAgICBuZXdTdGF0ZS52YWx1ZXMgPSB0aGlzLnByb3BzLnByZVZhbGlkYXRlKG5ld1N0YXRlLnZhbHVlcywgbmV3U3RhdGUsIHRoaXMucHJvcHMsIHRoaXMpXG4gICAgICBuZXdTdGF0ZS5lcnJvcnMgPSB0aGlzLnZhbGlkYXRlKG5ld1N0YXRlLnZhbHVlcywgbmV3U3RhdGUsIHRoaXMucHJvcHMpXG4gICAgfVxuICAgIHRoaXMuc2V0U3RhdGUobmV3U3RhdGUsICgpID0+IHtcbiAgICAgIHRoaXMucHJvcHMuc2F2ZVN0YXRlKHRoaXMuc3RhdGUsIHRoaXMucHJvcHMsIHRoaXMpXG4gICAgICBpZiAoIXNpbGVudCkge1xuICAgICAgICB0aGlzLmVtaXRDaGFuZ2UodGhpcy5zdGF0ZSwgdGhpcy5wcm9wcylcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZW1pdENoYW5nZSAoc3RhdGUsIGluaXRpYWwpIHtcbiAgICB0aGlzLnByb3BzLm9uQ2hhbmdlKHN0YXRlLCB0aGlzLnByb3BzLCBpbml0aWFsLCB0aGlzKVxuICB9XG5cbiAgdmFsaWRhdGUgKHZhbHVlcywgc3RhdGUsIHByb3BzKSB7XG4gICAgY29uc3QgZXJyb3JzID0gdGhpcy5wcm9wcy52YWxpZGF0ZShcbiAgICAgIHJlbW92ZU5lc3RlZEVycm9yVmFsdWVzKHZhbHVlcywgdGhpcy5zdGF0ZSA/IHRoaXMuc3RhdGUubmVzdGVkRXJyb3JzIDoge30pLFxuICAgICAgc3RhdGUsXG4gICAgICBwcm9wcyxcbiAgICAgIHRoaXNcbiAgICApXG4gICAgcmV0dXJuIGNsZWFuRXJyb3JzKGVycm9ycylcbiAgfVxuXG4gIHJlbmRlciAoKSB7XG4gICAgY29uc3QgcHJvcHMgPSB7XG4gICAgICAuLi50aGlzLnByb3BzLFxuICAgICAgLi4udGhpcy5zdGF0ZSxcbiAgICAgIC4uLnRoaXMuZ2V0QVBJKClcbiAgICB9XG4gICAgY29uc3QgeyBjb21wb25lbnQsIGNoaWxkcmVuLCAuLi5yZXN0IH0gPSBwcm9wc1xuICAgIGNvbnN0IHJlc29sdmVkQ2hpbGQgPSB0eXBlb2YgY2hpbGRyZW4gPT09ICdmdW5jdGlvbicgPyBjaGlsZHJlbihyZXN0KSA6IGNoaWxkcmVuXG4gICAgY29uc3QgUm9vdEVsID0gY29tcG9uZW50XG4gICAgaWYgKCFSb290RWwpIHtcbiAgICAgIHJldHVybiByZXNvbHZlZENoaWxkXG4gICAgfVxuICAgIHJldHVybiAoXG4gICAgICA8Um9vdEVsIGNsYXNzTmFtZT0nUmVhY3RGb3JtJz57cmVzb2x2ZWRDaGlsZH08L1Jvb3RFbD5cbiAgICApXG4gIH1cbn1cblxuRm9ybS5kaXNwbGF5TmFtZSA9ICdGb3JtJ1xuRm9ybS5kZWZhdWx0UHJvcHMgPSBGb3JtRGVmYXVsdFByb3BzXG5Gb3JtLmNoaWxkQ29udGV4dFR5cGVzID0geyBmb3JtQVBJOiBQcm9wVHlwZXMub2JqZWN0IH1cblxuZXhwb3J0IGRlZmF1bHQgRm9ybVxuXG4vLyBVdGlsc1xuXG5mdW5jdGlvbiBjbGVhbkVycm9ycyAoZXJyKSB7XG4gIGlmIChfLmlzT2JqZWN0KGVycikpIHtcbiAgICBjb25zdCByZXNvbHZlZCA9IF8ubWFwVmFsdWVzKGVyciwgY2xlYW5FcnJvcnMpXG4gICAgY29uc3QgZm91bmQgPSBfLnBpY2tCeShyZXNvbHZlZCwgZCA9PiBkKVxuICAgIHJldHVybiBPYmplY3Qua2V5cyhmb3VuZCkubGVuZ3RoID8gcmVzb2x2ZWQgOiB1bmRlZmluZWRcbiAgfVxuICBpZiAoXy5pc0FycmF5KGVycikpIHtcbiAgICBjb25zdCByZXNvbHZlZCA9IGVyci5tYXAoY2xlYW5FcnJvcnMpXG4gICAgY29uc3QgZm91bmQgPSByZXNvbHZlZC5maW5kKGQgPT4gZClcbiAgICByZXR1cm4gZm91bmQgPyByZXNvbHZlZCA6IHVuZGVmaW5lZFxuICB9XG4gIHJldHVybiBlcnJcbn1cblxuLy8gcmVtb3ZlTmVzdGVkRXJyb3JWYWx1ZXMgcmVjdXJzZXMgdGhlIHZhbHVlcyBvYmplY3QgYW5kIHR1cm5zIGFueVxuLy8gZmllbGQgdGhhdCBoYXMgYSB0cnV0aHkgY29ycmVzcG9uZGluZyBuZXN0ZWQgZm9ybSBlcnJvciBmaWVsZCBpbnRvIHVuZGVmaW5lZC5cbi8vIFRoaXMgYWxsb3dzIHByb3Blcmx5IHZhbGlkYXRpbmcgYSBuZXN0ZWQgZm9ybSBieSBkZXRlY3RpbmcgdGhhdCB1bmRlZmluZWQgdmFsdWVcbi8vIGluIHRoZSB2YWxpZGF0aW9uIGZ1bmN0aW9uXG5mdW5jdGlvbiByZW1vdmVOZXN0ZWRFcnJvclZhbHVlcyAodmFsdWVzLCBuZXN0ZWRFcnJvcnMpIHtcbiAgY29uc3QgcmVjdXJzZSA9IChjdXJyZW50LCBwYXRoID0gW10pID0+IHtcbiAgICBpZiAoXy5pc09iamVjdChjdXJyZW50KSkge1xuICAgICAgcmV0dXJuIF8ubWFwVmFsdWVzKGN1cnJlbnQsIChkLCBpKSA9PiB7XG4gICAgICAgIHJldHVybiByZWN1cnNlKGQsIFsuLi5wYXRoLCBpXSlcbiAgICAgIH0pXG4gICAgfVxuICAgIGlmIChfLmlzQXJyYXkoY3VycmVudCkpIHtcbiAgICAgIHJldHVybiBjdXJyZW50Lm1hcCgoZCwga2V5KSA9PiB7XG4gICAgICAgIHJldHVybiByZWN1cnNlKGQsIFsuLi5wYXRoLCBrZXldKVxuICAgICAgfSlcbiAgICB9XG4gICAgaWYgKCFfLmlzT2JqZWN0KGN1cnJlbnQpICYmICFfLmlzQXJyYXkoY3VycmVudCkgJiYgY3VycmVudCkge1xuICAgICAgcmV0dXJuIF8uc2V0KHZhbHVlcywgcGF0aCwgdW5kZWZpbmVkKVxuICAgIH1cbiAgICByZXR1cm4gY3VycmVudFxuICB9XG4gIHJlY3Vyc2UobmVzdGVkRXJyb3JzKVxuICByZXR1cm4gdmFsdWVzXG59XG4iXX0=